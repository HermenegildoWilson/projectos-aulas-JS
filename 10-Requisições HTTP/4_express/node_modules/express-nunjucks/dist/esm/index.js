import path from 'node:path';
import nunjucks, {} from 'nunjucks';
import NunjucksAsyncLoader from 'nunjucks-async-loader';
const envKeys = ['autoescape', 'throwOnUndefined', 'trimBlocks', 'lstripBlocks', 'tags'];
export const expressNunjucks = (apps = [], config = {}) => {
    apps = Array.isArray(apps) ? apps : [apps];
    const templateDirs = apps.map((app) => app.get('views')).flat();
    if (!apps.length) {
        throw new Error('option apps required.');
    }
    const Loader = (config.loader ?? NunjucksAsyncLoader);
    const loader = new Loader(templateDirs, {
        watch: config.watch,
        noCache: config.noCache,
    });
    const envOpts = envKeys.reduce((accum, name) => ({ ...accum, [name]: config[name] }), {});
    const env = new nunjucks.Environment(loader, envOpts);
    const filters = config.filters;
    if (filters) {
        Object.keys(filters).forEach((name) => {
            env.addFilter(name, filters[name]);
        });
    }
    const globals = config.globals;
    if (globals) {
        Object.keys(globals).forEach((name) => {
            env.addGlobal(name, globals[name]);
        });
    }
    const engine = function (filePath, ctx, cb) {
        const self = this;
        const name = path.extname(self.name) ? self.name : self.name + self.ext;
        const njkCtx = ctx._locals && ctx._locals.njkCtx;
        if (njkCtx) {
            ctx = { ...ctx, ...njkCtx };
        }
        env.render(name, ctx, cb);
    };
    apps.forEach((app) => {
        let engineExt = app.get('view engine');
        if (!engineExt) {
            engineExt = 'html';
            app.set('view engine', engineExt);
        }
        app.engine(engineExt, engine);
    });
    return {
        env: env,
        ctxProc: (ctxProcessors) => (req, res, next) => {
            const ctx = (res.locals.njkCtx = res.locals.njkCtx ?? {});
            ctxProcessors.forEach((ctxProc) => {
                ctxProc(req, ctx);
            });
            next();
        },
    };
};
export default expressNunjucks;
